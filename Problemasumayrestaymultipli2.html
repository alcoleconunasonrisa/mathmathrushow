<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Resolutor Pro - Matem√°ticas Completas</title>
    <style>
        :root {
            --primary: #00b4db;
            --secondary: #0077b6;
            --success: #43a047;
            --danger: #e53935;
            --warning: #fbc02d;
            --bg-card: #f8f9fa;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        
        body {
            font-family: 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            height: 100vh; display: flex; justify-content: center; align-items: center; overflow: hidden;
        }
        
        .container {
            width: 98%; max-width: 1000px; height: 95vh;
            background: white; border-radius: 28px; padding: 1.2rem;
            box-shadow: 0 20px 40px rgba(0,0,0,0.3);
            display: flex; flex-direction: column; position: relative;
        }

        .instruccion {
            background: var(--secondary); color: white; padding: 12px;
            border-radius: 15px; text-align: center; margin-bottom: 0.8rem;
            font-weight: bold; font-size: 1.1rem; box-shadow: 0 4px 10px rgba(0,0,0,0.1);
        }

        .contenido-juego { display: flex; flex: 1; gap: 1rem; overflow: hidden; }

        .pantalla { display: none; flex: 1.8; flex-direction: column; border-radius: 20px; background: var(--bg-card); padding: 1.5rem; overflow-y: auto; border: 2px solid #eee; }
        .pantalla.active { display: flex; }

        .btn-nivel { width: 100%; max-width: 300px; padding: 18px; margin: 10px; border: none; border-radius: 15px; color: white; font-weight: bold; font-size: 1.2rem; cursor: pointer; transition: 0.3s; box-shadow: 0 5px #777; }
        .btn-nivel:active { transform: translateY(3px); box-shadow: 0 2px #777; }

        .enunciado-box { 
            background: white; padding: 1.5rem; border-radius: 18px; 
            border-left: 8px solid var(--warning); margin-bottom: 1.2rem; 
            font-size: 1.25rem; line-height: 1.5; color: #333;
            box-shadow: 0 4px 12px rgba(0,0,0,0.05);
        }

        .avatar-icon { font-size: 3rem; display: block; margin-bottom: 10px; }
        .fila-dato { display: flex; align-items: center; background: white; padding: 15px; border-radius: 18px; margin-bottom: 12px; border: 2px solid #eee; }
        .etiqueta-dato { flex: 1; font-size: 1.1rem; color: #444; font-weight: 600; }

        .celda {
            width: 45px; height: 50px; border: 2px solid #ccc; border-radius: 8px;
            background: white; text-align: center; line-height: 46px;
            font-size: 1.8rem; font-weight: bold; transition: 0.2s;
        }
        .celda.activa { border: 3px solid var(--primary); background: #e0f7fa; }
        .celda.correcta { border-color: var(--success); color: var(--success); background: #e8f5e9; }
        .celda.incorrecta { border-color: var(--danger); background: #ffebee; color: var(--danger); animation: shake 0.4s; }

        @keyframes shake { 0%, 100% { transform: translateX(0); } 25% { transform: translateX(-8px); } 75% { transform: translateX(8px); } }

        .zona-teclado { flex: 1; display: flex; flex-direction: column; justify-content: center; align-items: center; background: #fff; border-radius: 20px; border: 2px solid #eee; }
        .teclado { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; width: 100%; max-width: 280px; padding: 15px; }
        .tecla { padding: 18px 0; font-size: 1.6rem; border: none; border-radius: 18px; background: #f5f5f5; font-weight: bold; box-shadow: 0 5px #ccc; cursor: pointer; }

        .tablero { font-family: 'Courier New', monospace; display: flex; flex-direction: column; align-items: flex-end; font-size: 2.2rem; font-weight: bold; }
        .fila-tablero { display: flex; height: 52px; justify-content: flex-end; align-items: center; }
        .fila-linea { border-bottom: 4px solid #333; width: 100%; margin: 5px 0; }
        
        #caja-solucion { display: none; background: #e8f5e9; padding: 25px; border-radius: 20px; border: 3px solid var(--success); margin-top: 20px; text-align: center; }
        #modal-victoria { display: none; position: absolute; inset: 0; background: rgba(255,255,255,0.98); z-index: 100; flex-direction: column; justify-content: center; align-items: center; border-radius: 28px; }

        @media (max-width: 768px) { .contenido-juego { flex-direction: column; } .celda { width: 35px; height: 42px; font-size: 1.5rem; line-height: 38px; } }
    </style>
</head>
<body>

<div class="container">
    <div id="instruccion" class="instruccion">¬°Hola! Elige un nivel para practicar</div>
    
    <div id="pantalla-menu" class="pantalla active" style="justify-content: center; align-items: center; text-align: center;">
        <h1 style="color:var(--secondary); margin-bottom:25px; font-size: 2.5rem;">Aprende Problemas üöÄ</h1>
        <button class="btn-nivel" style="background:var(--success)" onclick="empezarJuego(1)">Nivel 1 (F√°cil)</button>
        <button class="btn-nivel" style="background:#fb8c00" onclick="empezarJuego(2)">Nivel 2 (Medio)</button>
        <button class="btn-nivel" style="background:var(--danger)" onclick="empezarJuego(3)">Nivel 3 (Dif√≠cil)</button>
        <hr style="width: 80%; margin: 20px auto; border: 0; border-top: 1px solid #ddd;">
        <button class="btn-nivel" style="background:#607d8b; max-width: 250px; font-size: 1rem;" onclick="window.location.href='main-index.html'">üè† Volver al Inicio</button>
    </div>

    <div id="pantalla-juego" class="contenido-juego" style="display:none;">
        <div id="vista-planteamiento" class="pantalla active">
            <div id="enunciado" class="enunciado-box"></div>
            <div class="fila-dato"><span id="label-d1" class="etiqueta-dato">Dato 1:</span><div id="box-d1" style="display:flex; gap:8px"></div></div>
            <div class="fila-dato"><span id="label-d2" class="etiqueta-dato">Dato 2:</span><div id="box-d2" style="display:flex; gap:8px"></div></div>
            <div id="area-op" style="margin-top:1.5rem; display:none;">
                <p style="margin-bottom:15px; font-weight:800; color:var(--secondary); text-align:center;">¬øQU√â OPERACI√ìN NECESITAS?</p>
                <div style="display:grid; grid-template-columns: 1fr 1fr; gap:12px;">
                    <button id="btn-suma" class="btn-nivel" style="background:var(--success); margin:0; max-width: none;" onclick="seleccionarOp('+')">SUMAR (+)</button>
                    <button id="btn-resta" class="btn-nivel" style="background:var(--danger); margin:0; max-width: none;" onclick="seleccionarOp('-')">RESTAR (-)</button>
                    <button id="btn-multi" class="btn-nivel" style="background:var(--primary); margin:0; max-width: none; grid-column: span 2;" onclick="seleccionarOp('x')">MULTIPLICAR (x)</button>
                </div>
                <div id="msg-error-op" style="display:none; color:var(--danger); padding:12px; background:#ffebee; margin-top:12px; border-radius:15px; text-align:center; font-weight:bold;">‚ùå Operaci√≥n incorrecta</div>
            </div>
        </div>

        <div id="vista-calculo" class="pantalla">
            <div id="resumen-calculo" style="background:#e3f2fd; padding:10px; border-radius:15px; margin-bottom:1rem; text-align:center; font-weight:bold; color:var(--secondary);"></div>
            <div style="flex:1; display:flex; flex-direction:column; justify-content:center; align-items:center;">
                <div id="tablero-calculo" class="tablero"></div>
                <div id="caja-solucion">
                    <h2 style="color:var(--success);">üåü ¬°LO LOGRASTE!</h2>
                    <p id="texto-solucion-final" style="font-size:1.2rem; margin:15px 0;"></p>
                    <button class="btn-nivel" style="background:var(--success); width:auto; padding:12px 40px;" onclick="mostrarVictoria()">Continuar</button>
                </div>
            </div>
        </div>

        <div class="zona-teclado">
            <div class="teclado">
                <button class="tecla" onclick="inputNum(1)">1</button><button class="tecla" onclick="inputNum(2)">2</button><button class="tecla" onclick="inputNum(3)">3</button>
                <button class="tecla" onclick="inputNum(4)">4</button><button class="tecla" onclick="inputNum(5)">5</button><button class="tecla" onclick="inputNum(6)">6</button>
                <button class="tecla" onclick="inputNum(7)">7</button><button class="tecla" onclick="inputNum(8)">8</button><button class="tecla" onclick="inputNum(9)">9</button>
                <button class="tecla" style="background:#ffcdd2;" onclick="borrar()">C</button><button class="tecla" onclick="inputNum(0)">0</button>
                <button class="tecla" style="background:#e1f5fe;" onclick="irMenu()">üè†</button>
            </div>
        </div>
    </div>

    <div id="modal-victoria">
        <div style="font-size: 5rem;">üèÜ</div>
        <h2 style="color: var(--success); margin-bottom:20px;">¬°Excelente!</h2>
        <button class="btn-nivel" style="background:var(--success)" onclick="empezarJuego(nivelActual)">Nuevo Problema</button>
        <button class="btn-nivel" style="background:var(--secondary)" onclick="irMenu()">Cambiar Nivel</button>
    </div>
</div>

<script>
    let nivelActual = 1, fase = "D1", PROBLEMA = {}, celdasActivas = [], subIndice = 0;
    let valorObjetivoMulti = "";

    const configProblemas = {
        nombres: ["Mar√≠a", "Lucas", "Emma", "Leo", "Sof√≠a", "Hugo", "Dani", "Carla"],
        temas: [
            { obj: "caramelo", plural: "caramelos", icono: "üç¨", vSuma: "le regalan", vResta: "se come", vMulti: "bolsas con", solSuma: "Ahora tiene X Y.", solResta: "Le quedan X Y.", solMulti: "Tiene un total de X Y." },
            { obj: "p√°jaro", plural: "p√°jaros", icono: "üê¶", vSuma: "vienen", vResta: "se escapan", vMulti: "√°rboles con", solSuma: "En total hay X Y.", solResta: "Quedan X Y.", solMulti: "Hay un total de X Y." },
            { obj: "euro", plural: "euros", icono: "üí∂", vSuma: "encuentra", vResta: "paga", vMulti: "huchas con", solSuma: "Tiene ahorrados X Y.", solResta: "Le sobran X Y.", solMulti: "Ha juntado X Y." },
            { obj: "manzana", plural: "manzanas", icono: "üçé", vSuma: "cosecha", vResta: "tira", vMulti: "cajas con", solSuma: "Tiene un total de X Y.", solResta: "Ahora tiene X Y.", solMulti: "Ha recogido X Y." }
        ]
    };

    function empezarJuego(n) {
        nivelActual = n; fase = "D1";
        document.getElementById('modal-victoria').style.display = "none";
        document.getElementById('pantalla-menu').style.display = "none";
        document.getElementById('pantalla-juego').style.display = "flex";
        document.getElementById('vista-planteamiento').style.display = "flex";
        document.getElementById('vista-calculo').style.display = "none";
        document.getElementById('area-op').style.display = "none";
        document.getElementById('caja-solucion').style.display = "none";
        document.getElementById('tablero-calculo').innerHTML = "";
        document.getElementById('instruccion').textContent = "Paso 1: Extrae los n√∫meros del problema";
        
        const tipos = ['suma', 'resta', 'multi'];
        const tipo = tipos[Math.floor(Math.random() * tipos.length)];
        const tema = configProblemas.temas[Math.floor(Math.random() * configProblemas.temas.length)];
        const nombre = configProblemas.nombres[Math.floor(Math.random() * configProblemas.nombres.length)];
        
        let v1, v2, label1, label2, enunciado;
        
        if(tipo === 'multi'){
            v1 = (n === 1) ? (Math.floor(Math.random()*41)+10) : (n === 2 ? Math.floor(Math.random()*451)+50 : Math.floor(Math.random()*900)+100);
            v2 = (n === 1) ? (Math.floor(Math.random()*5)+11) : (n === 2 ? Math.floor(Math.random()*24)+12 : Math.floor(Math.random()*75)+25);
            label1 = "Cantidad"; label2 = "En cada uno";
            enunciado = `${nombre} tiene <strong>${v1}</strong> ${tema.vMulti} <strong>${v2}</strong> ${tema.plural} cada uno.`;
        } else {
            const max = Math.pow(10, n+1);
            v1 = Math.floor(Math.random() * (max - 10)) + 10;
            v2 = (tipo === 'resta') ? Math.floor(Math.random() * (v1 - 5)) + 5 : Math.floor(Math.random() * (max - 10)) + 10;
            label1 = "Ten√≠a"; 
            label2 = (tipo === 'suma') ? "Recibe" : "Pierde";
            enunciado = (tipo === 'suma') ? `${nombre} ten√≠a <strong>${v1}</strong> ${tema.plural} y luego ${tema.vSuma} <strong>${v2}</strong> m√°s.` :
                        `${nombre} ten√≠a <strong>${v1}</strong> ${tema.plural} y luego ${tema.vResta} <strong>${v2}</strong> de ellos.`;
        }

        v1 = v1.toString(); v2 = v2.toString();

        PROBLEMA = {
            n1: v1, n2: v2, op: (tipo==='suma' ? '+' : (tipo==='resta' ? '-' : 'x')),
            res: (tipo==='suma' ? parseInt(v1)+parseInt(v2) : (tipo==='resta' ? parseInt(v1)-parseInt(v2) : parseInt(v1)*parseInt(v2))).toString(),
            tema: tema, solTemplate: (tipo==='suma' ? tema.solSuma : (tipo==='resta' ? tema.solResta : tema.solMulti)), 
            nombreFinal: tema.plural
        };

        document.getElementById('enunciado').innerHTML = `<span class="avatar-icon">${tema.icono}</span>${enunciado}<br><br>¬øCu√°ntos hay al final?`;
        document.getElementById('label-d1').textContent = label1 + ":";
        document.getElementById('label-d2').textContent = label2 + ":";
        document.getElementById('box-d1').innerHTML = ""; 
        document.getElementById('box-d2').innerHTML = "";
        activarGrupo(crearCeldas('box-d1', PROBLEMA.n1));
    }

    function crearCeldas(id, val) {
        const cont = (typeof id === 'string') ? document.getElementById(id) : id;
        const arr = [];
        for(let i=0; i<val.length; i++) {
            const c = document.createElement('div'); c.className = 'celda';
            cont.appendChild(c); arr.push(c);
        }
        return arr;
    }

    function activarGrupo(grupo) {
        celdasActivas = Array.from(grupo);
        subIndice = celdasActivas.length - 1;
        if(celdasActivas[subIndice]) celdasActivas[subIndice].classList.add('activa');
    }

    function seleccionarOp(simbolo) {
        if(simbolo === PROBLEMA.op) {
            document.getElementById('vista-planteamiento').style.display = "none";
            document.getElementById('vista-calculo').style.display = "flex";
            const tablero = document.getElementById('tablero-calculo');
            
            const f1 = document.createElement('div'); f1.className = 'fila-tablero';
            for(let char of PROBLEMA.n1){ const d=document.createElement('div'); d.textContent=char; d.style.width="45px"; d.style.textAlign="center"; f1.appendChild(d); }
            tablero.appendChild(f1);

            const f2 = document.createElement('div'); f2.className = 'fila-tablero';
            const sign = document.createElement('span'); sign.textContent = (PROBLEMA.op === 'x' ? '√ó' : PROBLEMA.op); sign.style.marginRight="10px";
            f2.appendChild(sign);
            for(let char of PROBLEMA.n2){ const d=document.createElement('div'); d.textContent=char; d.style.width="45px"; d.style.textAlign="center"; f2.appendChild(d); }
            tablero.appendChild(f2);

            const linea = document.createElement('div'); linea.className = 'fila-linea';
            tablero.appendChild(linea);

            if(PROBLEMA.op === 'x') {
                prepararMultiPaso(1);
            } else {
                fase = "CALC";
                const fRes = document.createElement('div'); fRes.className = 'fila-tablero';
                tablero.appendChild(fRes);
                activarGrupo(crearCeldas(fRes, PROBLEMA.res));
                document.getElementById('instruccion').textContent = "Paso 3: Realiza la operaci√≥n";
                document.getElementById('resumen-calculo').textContent = `OPERACI√ìN: ${PROBLEMA.n1} ${PROBLEMA.op} ${PROBLEMA.n2}`;
            }
        } else {
            document.getElementById('msg-error-op').style.display = "block";
            setTimeout(() => { document.getElementById('msg-error-op').style.display = "none"; }, 2000);
        }
    }

    function prepararMultiPaso(etapa) {
        const tablero = document.getElementById('tablero-calculo');
        const f = document.createElement('div'); f.className = 'fila-tablero';
        tablero.appendChild(f);
        
        if(etapa === 1) {
            fase = "MULTI_U";
            const u2 = parseInt(PROBLEMA.n2) % 10;
            valorObjetivoMulti = (parseInt(PROBLEMA.n1) * u2).toString();
            document.getElementById('instruccion').textContent = `Multiplica unidades: ${PROBLEMA.n1} √ó ${u2}`;
            activarGrupo(crearCeldas(f, valorObjetivoMulti));
            document.getElementById('resumen-calculo').textContent = `PASO 1: ${PROBLEMA.n1} √ó ${u2}`;
        } else if(etapa === 2) {
            fase = "MULTI_D";
            const d2 = Math.floor(parseInt(PROBLEMA.n2) / 10);
            valorObjetivoMulti = (parseInt(PROBLEMA.n1) * d2).toString();
            document.getElementById('instruccion').textContent = `Multiplica decenas: ${PROBLEMA.n1} √ó ${d2}`;
            document.getElementById('resumen-calculo').textContent = `PASO 2: ${PROBLEMA.n1} √ó ${d2}`;
            const celdas = crearCeldas(f, valorObjetivoMulti + "X");
            const xCell = celdas[celdas.length - 1];
            xCell.textContent = "X"; xCell.style.color = "red"; xCell.className = "celda correcta";
            activarGrupo(celdas.slice(0, -1));
        } else {
            fase = "MULTI_SUMA";
            const linea = document.createElement('div'); linea.className = 'fila-linea';
            tablero.appendChild(linea);
            const fSum = document.createElement('div'); fSum.className = 'fila-tablero';
            tablero.appendChild(fSum);
            valorObjetivoMulti = PROBLEMA.res;
            document.getElementById('instruccion').textContent = "¬°Ahora suma los resultados!";
            document.getElementById('resumen-calculo').textContent = `PASO FINAL: SUMA TODO`;
            activarGrupo(crearCeldas(fSum, valorObjetivoMulti));
        }
    }

    function inputNum(n) {
        if(fase === "FIN") return;
        let objetivo = (fase === "D1") ? PROBLEMA.n1 : 
                       (fase === "D2") ? PROBLEMA.n2 : 
                       (fase.startsWith("MULTI")) ? valorObjetivoMulti : PROBLEMA.res;
        let celda = celdasActivas[subIndice];
        if(!celda) return;

        if(n.toString() === objetivo[subIndice]) {
            celda.textContent = n; celda.className = 'celda correcta';
            subIndice--;
            if(subIndice >= 0) {
                celdasActivas[subIndice].classList.add('activa');
            } else {
                avanzar();
            }
        } else {
            celda.textContent = n; celda.classList.add('incorrecta');
            setTimeout(() => { celda.classList.remove('incorrecta'); celda.textContent = ""; }, 400);
        }
    }

    function avanzar() {
        if(fase === "D1") { fase = "D2"; activarGrupo(crearCeldas('box-d2', PROBLEMA.n2)); }
        else if(fase === "D2") { fase = "OP"; document.getElementById('area-op').style.display = "block"; }
        else if(fase === "MULTI_U") { setTimeout(() => prepararMultiPaso(2), 500); }
        else if(fase === "MULTI_D") { setTimeout(() => prepararMultiPaso(3), 500); }
        else { 
            fase = "FIN"; 
            document.getElementById('caja-solucion').style.display = "block";
            document.getElementById('texto-solucion-final').textContent = PROBLEMA.solTemplate.replace("X", PROBLEMA.res).replace("Y", PROBLEMA.nombreFinal);
        }
    }

    function borrar() { if(celdasActivas[subIndice] && !celdasActivas[subIndice].classList.contains('correcta')) celdasActivas[subIndice].textContent = ""; }
    function mostrarVictoria() { document.getElementById('modal-victoria').style.display = "flex"; }
    function irMenu() { location.reload(); }
</script>
</body>
</html>
